<!DOCTYPE html>
<html>
<head>
<meta charset="utf-8"/>
<title>驾车导航</title>
<script src="http://api.map.baidu.com/api?v=1.2"></script>
</head>
<body>
<input type="text" name="start_point" id="start_point" value="{$start_point_lat},{$start_point_lng}">
<input type="text" name="end_point" id="end_point" value="{$end_point_lat},{$end_point_lng}">
<div id="container" style="width:400px;height:548px"></div>
<div id="panel" style="position:relative;margin-top:10px"></div>
<script>
var map =new BMap.Map('container');
map.centerAndZoom(new BMap.Point(121.595329,31.256644), 11);

var driving =new BMap.DrivingRoute(map, {
    onSearchComplete: function(results){
        if (driving.getStatus() == BMAP_STATUS_SUCCESS) {
            // 地图覆盖物
            addOverlays(results);
            // 方案描述
            addText(results);
        }
    }
});
var st_lng = {$start_point_lng};
var st_lat = {$start_point_lat};
var en_lng = {$end_point_lng};
var en_lat = {$end_point_lat};

//parseFloat({$end_point_lng}),parseFloat({$end_point_lat})
driving.search(  {title: '你的位置', point: new BMap.Point(st_lng,st_lat)}, 
		         {title: '终点', point: new BMap.Point(en_lng,en_lat)}
		         );
function addOverlays(results) {
    // 自行添加起点和终点
var start = results.getStart();
    var end = results.getEnd();
    addStart(start.point, start.title);
    addEnd(end.point, end.title);
    var viewPoints = [start.point, end.point];
    // 获取方案
var plan = results.getPlan(0);
    // 获取方案中包含的路线
for (var i =0; i < plan.getNumRoutes(); i ++) {
        addRoute(plan.getRoute(i).getPath());
        viewPoints.concat(plan.getRoute(i).getPath());
    }
    // 设置地图视野
    map.setViewport(viewPoints, {
        margins: [40, 10, 10, 10]
    });
}

// 添加方案描述
function addText(results) {
    var plan = results.getPlan(0);
    // 获取方案中包含的路线
var htmls = [];
    for (var i =0; i < plan.getNumRoutes(); i ++) {
        var route = plan.getRoute(i);
        for (var j =0; j < route.getNumSteps(); j ++) {
            var curStep = route.getStep(j);
            htmls.push((j +1) +'. '+ curStep.getDescription() +'<br />');
        }
    }
    var panel = document.getElementById('panel');
    panel.innerHTML = htmls.join('');
    panel.style.lineHeight ='1.1em';
    panel.style.fontSize ='12px';
}

// 添加起点覆盖物
function addStart(point, title){
    map.addOverlay(new BMap.Marker(point, {
        title: title,
        icon: new BMap.Icon('__STATIC__/weixin/images/blue.png', new BMap.Size(40, 48), {
            anchor: new BMap.Size(0, 0)
        })}));
}

// 添加终点覆盖物
function addEnd(point, title){
    map.addOverlay(new BMap.Marker(point, {
        title: title,
        icon: new BMap.Icon('__STATIC__/weixin/images/red.png', new BMap.Size(38, 41), {
            anchor: new BMap.Size(0, 0)
        })}));
}

// 添加路线
function addRoute(path){
    map.addOverlay(new BMap.Polyline(path, {
        strokeColor: '#333',
        enableClicking: false
    }));
}
</script>
</body>
</html>